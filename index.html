<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Brew Buddy</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'VT323', monospace; }
    body { 
      -webkit-font-smoothing: none;
      image-rendering: pixelated;
      background: #0a0a0a;
    }
    h1, h2, h3, .pixel-title { font-family: 'Press Start 2P', cursive; }
    .pb-safe { padding-bottom: env(safe-area-inset-bottom, 0); }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
    
    /* Pixel border effect */
    .pixel-border {
      border: 4px solid;
      border-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='6' height='6'%3E%3Crect width='2' height='2' fill='%239333ea'/%3E%3Crect x='2' width='2' height='2' fill='%237c3aed'/%3E%3Crect x='4' width='2' height='2' fill='%239333ea'/%3E%3Crect y='2' width='2' height='2' fill='%237c3aed'/%3E%3Crect x='2' y='2' width='2' height='2' fill='transparent'/%3E%3Crect x='4' y='2' width='2' height='2' fill='%237c3aed'/%3E%3Crect y='4' width='2' height='2' fill='%239333ea'/%3E%3Crect x='2' y='4' width='2' height='2' fill='%237c3aed'/%3E%3Crect x='4' y='4' width='2' height='2' fill='%239333ea'/%3E%3C/svg%3E") 2 stretch;
    }
    
    /* Scanline effect */
    .scanlines::after {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: repeating-linear-gradient(
        0deg,
        rgba(0,0,0,0.1) 0px,
        rgba(0,0,0,0.1) 1px,
        transparent 1px,
        transparent 2px
      );
      pointer-events: none;
      z-index: 9999;
    }
    
    /* Glow effect */
    .pixel-glow {
      text-shadow: 0 0 10px #a855f7, 0 0 20px #a855f7, 0 0 30px #a855f7;
    }
    
    /* Blink animation */
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .blink { animation: blink 1s infinite; }
    
    /* Bounce animation */
    @keyframes bounce-pixel {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }
    .bounce-pixel:hover { animation: bounce-pixel 0.3s ease-in-out; }
    
    /* Float animation for brewer icons */
    @keyframes float {
      0%, 100% { transform: translateY(0) rotate(0deg); }
      25% { transform: translateY(-6px) rotate(2deg); }
      75% { transform: translateY(-3px) rotate(-2deg); }
    }
    .float-1 { animation: float 3s ease-in-out infinite; animation-delay: 0s; }
    .float-2 { animation: float 3s ease-in-out infinite; animation-delay: 0.3s; }
    .float-3 { animation: float 3s ease-in-out infinite; animation-delay: 0.6s; }
    .float-4 { animation: float 3s ease-in-out infinite; animation-delay: 0.9s; }
    .float-5 { animation: float 3s ease-in-out infinite; animation-delay: 1.2s; }
    
    /* Steam animation */
    @keyframes steam {
      0% { transform: translateY(0) scale(1); opacity: 0.6; }
      50% { transform: translateY(-10px) scale(1.1); opacity: 0.3; }
      100% { transform: translateY(-20px) scale(0.8); opacity: 0; }
    }
    .steam { animation: steam 2s ease-out infinite; }
    .steam-delay { animation: steam 2s ease-out infinite; animation-delay: 0.7s; }
    .steam-delay-2 { animation: steam 2s ease-out infinite; animation-delay: 1.4s; }
    
    /* Animated border highlight */
    .border-animate {
      position: relative;
      background: #111827;
    }
    .border-animate::before {
      content: '';
      position: absolute;
      inset: 0;
      padding: 3px;
      background: linear-gradient(90deg, transparent, #fb923c, transparent);
      background-size: 200% 100%;
      animation: border-flow 6s linear infinite;
      -webkit-mask: 
        linear-gradient(#fff 0 0) content-box, 
        linear-gradient(#fff 0 0);
      mask: 
        linear-gradient(#fff 0 0) content-box, 
        linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      pointer-events: none;
    }
    @keyframes border-flow {
      0% { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }
    .border-delay-1::before { animation-delay: 0s; }
    .border-delay-2::before { animation-delay: 1.2s; }
    .border-delay-3::before { animation-delay: 2.4s; }
    .border-delay-4::before { animation-delay: 3.6s; }
    .border-delay-5::before { animation-delay: 4.8s; }
    
    /* Wiggle animation */
    @keyframes wiggle {
      0%, 100% { transform: rotate(0deg); }
      25% { transform: rotate(-3deg); }
      75% { transform: rotate(3deg); }
    }
    .wiggle:hover { animation: wiggle 0.3s ease-in-out; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Supabase client
    const SUPABASE_URL = 'https://yiimyoabdgsubradtejd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpaW15b2FiZGdzdWJyYWR0ZWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwODA5NzQsImV4cCI6MjA4NTY1Njk3NH0.pUWRRIae1GU5u36QcX2JeVR5Qa3JpbSaSUFtHTe2cDU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Icons
    const Icon = ({ name, className = "w-6 h-6", ...props }) => {
      const ref = useRef(null);
      useEffect(() => {
        if (ref.current && lucide.icons[name]) {
          ref.current.innerHTML = '';
          const icon = lucide.createElement(lucide.icons[name]);
          icon.setAttribute('class', className);
          if (props.fill) icon.setAttribute('fill', props.fill);
          ref.current.appendChild(icon);
        }
      }, [name, className, props.fill]);
      return <span ref={ref} className="inline-flex" />;
    };

    const Coffee = (props) => <Icon name="Coffee" {...props} />;
    const Play = (props) => <Icon name="Play" {...props} />;
    const Pause = (props) => <Icon name="Pause" {...props} />;
    const RotateCcw = (props) => <Icon name="RotateCcw" {...props} />;
    const SkipForward = (props) => <Icon name="SkipForward" {...props} />;
    const ExternalLink = (props) => <Icon name="ExternalLink" {...props} />;
    const Check = (props) => <Icon name="Check" {...props} />;
    const ChevronRight = (props) => <Icon name="ChevronRight" {...props} />;
    const ChevronLeft = (props) => <Icon name="ChevronLeft" {...props} />;
    const Star = (props) => <Icon name="Star" {...props} />;
    const History = (props) => <Icon name="History" {...props} />;
    const LogIn = (props) => <Icon name="LogIn" {...props} />;
    const User = (props) => <Icon name="User" {...props} />;
    const Loader = (props) => <Icon name="Loader" {...props} />;
    const Plus = (props) => <Icon name="Plus" {...props} />;
    const X = (props) => <Icon name="X" {...props} />;
    const Trash = (props) => <Icon name="Trash2" {...props} />;
    const Edit = (props) => <Icon name="Pencil" {...props} />;

    const COUNTRIES = ['Ethiopia', 'Colombia', 'Brazil', 'Guatemala', 'Costa Rica', 'Kenya', 'Indonesia', 'Honduras', 'Panama', 'El Salvador', 'Nepal', 'India', 'Rwanda', 'Burundi', 'Other'];
    const VARIETALS = ['Heirloom', 'Bourbon', 'Typica', 'Caturra', 'Catuai', 'Geisha', 'SL-28', 'SL-34', 'Pacamara', 'Castillo', 'Blend', 'Other'];

    // Helper to convert Celsius to Fahrenheit
    const cToF = (c) => Math.round((c * 9/5) + 32);

    // BREWERS AND RECIPES
    const BREWERS = {
      hario_switch: { name: 'Hario Switch', image: 'images/hario-switch.png' },
      v60: { name: 'Hario V60', image: 'images/hario-v60.png' },
      aeropress: { name: 'AeroPress', image: 'images/aeropress.png' },
      chemex: { name: 'Chemex', image: 'images/chemex.png' },
      espresso: { name: 'Espresso', image: 'images/espresso.png' }
    };

    const RECIPES = {
      hario_switch: [
        {
          id: 'switch_classic',
          name: 'Classic (La Cabra)',
          coffee: 15,
          water: 250,
          grind: 'Medium-Coarse',
          temp: 96,
          source: 'https://lacabra.dk/blogs/journal/hario-switch-recipe',
          taste: 'Balanced, clean, lightly sweet',
          bestFor: 'Washed Ethiopia, Kenya, Guatemala',
          stats: { body: 2, clarity: 4, sweetness: 3, acidity: 3 },
          steps: [
            { name: 'Add Coffee', water: 0, duration: 0, instruction: 'Rinse filter, add 15g coffee with switch CLOSED' },
            { name: 'Bloom', water: 60, duration: 45, instruction: 'Pour 60g water for bloom' },
            { name: 'Main Pour', water: 250, duration: 30, instruction: 'OPEN switch, pour remaining 190g' },
            { name: 'Drawdown', water: 250, duration: 45, instruction: 'Let it drain completely' }
          ]
        },
        {
          id: 'switch_mugen',
          name: 'Immersion (Mugen Hack)',
          coffee: 15,
          water: 300,
          grind: 'Medium',
          temp: 94,
          source: 'https://www.youtube.com/watch?v=QjIvLsON5mo',
          taste: 'Sweet, round, fuller body',
          bestFor: 'Natural Ethiopia, Honey Costa Rica',
          stats: { body: 4, clarity: 2, sweetness: 4, acidity: 2 },
          steps: [
            { name: 'First Pour', water: 150, duration: 10, instruction: 'Add 150g water and stir' },
            { name: 'Steep', water: 150, duration: 60, instruction: 'Wait 60 seconds' },
            { name: 'Open & Pour', water: 300, duration: 30, instruction: 'OPEN switch, slowly add remaining 150g' },
            { name: 'Drawdown', water: 300, duration: 140, instruction: 'Let it drain (~4 min total)' }
          ]
        }
      ],
      v60: [
        {
          id: 'v60_balanced',
          name: 'Balanced (Kaldi\'s)',
          coffee: 16,
          water: 256,
          grind: 'Medium-Fine',
          temp: 96,
          source: 'https://kaldiscoffee.com/blogs/news/hario-v60-brew-guide',
          taste: 'Bright, crisp, high clarity',
          bestFor: 'Washed Ethiopia, Rwanda, Burundi',
          stats: { body: 1, clarity: 5, sweetness: 2, acidity: 4 },
          steps: [
            { name: 'Bloom', water: 40, duration: 40, instruction: 'Pour 40g, swirl gently' },
            { name: 'Main Pour', water: 256, duration: 100, instruction: 'Pour steadily to 256g' },
            { name: 'Drawdown', water: 256, duration: 40, instruction: 'Total time ~3 min' }
          ]
        },
        {
          id: 'v60_pulse',
          name: 'Pulse Pour (5x60g)',
          coffee: 20,
          water: 300,
          grind: 'Medium-Fine',
          temp: 96,
          source: 'https://www.youtube.com/watch?v=AI4ynXzkSQo',
          taste: 'Sweet, rounded, still clean',
          bestFor: 'Washed Colombia, Honey Guatemala',
          stats: { body: 2, clarity: 4, sweetness: 4, acidity: 3 },
          steps: [
            { name: 'Bloom', water: 60, duration: 45, instruction: 'Pour 60g bloom, swirl' },
            { name: 'Pour 2', water: 120, duration: 30, instruction: 'Pour to 120g' },
            { name: 'Pour 3', water: 180, duration: 30, instruction: 'Pour to 180g' },
            { name: 'Pour 4', water: 240, duration: 30, instruction: 'Pour to 240g' },
            { name: 'Pour 5', water: 300, duration: 30, instruction: 'Pour to 300g' },
            { name: 'Drawdown', water: 300, duration: 45, instruction: 'Total time ~4 min' }
          ]
        }
      ],
      aeropress: [
        {
          id: 'aeropress_standard',
          name: 'Standard',
          coffee: 16,
          water: 200,
          grind: 'Medium-Fine',
          temp: 85,
          source: 'https://aeropress.com/pages/how-to-brew',
          taste: 'Comforting, balanced, chocolate-forward',
          bestFor: 'Brazil natural, Colombia medium roast',
          stats: { body: 3, clarity: 3, sweetness: 4, acidity: 2 },
          steps: [
            { name: 'Add Water', water: 200, duration: 10, instruction: 'Add all 200g water' },
            { name: 'Stir', water: 200, duration: 10, instruction: 'Stir 3 times' },
            { name: 'Steep', water: 200, duration: 40, instruction: 'Wait' },
            { name: 'Press', water: 200, duration: 30, instruction: 'Press gently for 30s' }
          ]
        },
        {
          id: 'aeropress_championship',
          name: 'Championship Style',
          coffee: 18,
          water: 100,
          grind: 'Fine',
          temp: 80,
          bypass: 100,
          source: 'https://aeropress.com/pages/wac-recipes',
          taste: 'Intense, juicy, aromatic',
          bestFor: 'Natural Ethiopia, Anaerobic Colombia',
          stats: { body: 5, clarity: 3, sweetness: 5, acidity: 4 },
          steps: [
            { name: 'Add Water', water: 100, duration: 10, instruction: 'Add 100g water' },
            { name: 'Stir', water: 100, duration: 10, instruction: 'Stir gently' },
            { name: 'Press', water: 100, duration: 30, instruction: 'Press after 25-50s' },
            { name: 'Bypass', water: 100, duration: 10, instruction: 'Add 100g hot water to cup' }
          ]
        }
      ],
      chemex: [
        {
          id: 'chemex_howell',
          name: 'George Howell (2 cups)',
          coffee: 32,
          water: 500,
          grind: 'Medium-Coarse',
          temp: 96,
          source: 'https://www.georgehowellcoffee.com/brew-guide/chemex/',
          taste: 'Elegant, ultra-clean, bright',
          bestFor: 'Washed Ethiopia, Kenya, light Panama',
          stats: { body: 1, clarity: 5, sweetness: 2, acidity: 5 },
          steps: [
            { name: 'Bloom', water: 65, duration: 45, instruction: 'Pour 65g, let bloom' },
            { name: 'Pour 1', water: 250, duration: 60, instruction: 'Pour slowly to 250g' },
            { name: 'Pour 2', water: 400, duration: 60, instruction: 'Pour to 400g' },
            { name: 'Pour 3', water: 500, duration: 60, instruction: 'Pour to 500g' },
            { name: 'Drawdown', water: 500, duration: 75, instruction: 'Total ~5 min' }
          ]
        },
        {
          id: 'chemex_madcap',
          name: 'Madcap',
          coffee: 42,
          water: 680,
          grind: 'Medium-Coarse',
          temp: 96,
          source: 'https://madcapcoffee.com/brew-guides/chemex/',
          taste: 'Clean but richer, gentle sweetness',
          bestFor: 'Colombia, Costa Rica, Guatemala',
          stats: { body: 2, clarity: 4, sweetness: 3, acidity: 3 },
          steps: [
            { name: 'Bloom', water: 80, duration: 45, instruction: 'Pour 80g bloom' },
            { name: 'Pour 1', water: 280, duration: 60, instruction: 'Pour to 280g' },
            { name: 'Pour 2', water: 480, duration: 60, instruction: 'Pour to 480g' },
            { name: 'Pour 3', water: 680, duration: 60, instruction: 'Pour to 680g' },
            { name: 'Drawdown', water: 680, duration: 135, instruction: 'Total 6-7 min' }
          ]
        }
      ],
      espresso: [
        {
          id: 'espresso_classic',
          name: 'Classic 1:2',
          coffee: 18,
          water: 36,
          grind: 'Fine',
          temp: 93,
          taste: 'Balanced, sweet, structured',
          bestFor: 'Medium roast espresso blends',
          stats: { body: 4, clarity: 3, sweetness: 4, acidity: 2 },
          steps: [
            { name: 'Extract', water: 36, duration: 28, instruction: '18g in ‚Üí 36g out in 25-30s' }
          ]
        },
        {
          id: 'espresso_ristretto',
          name: 'Ristretto 1:1.4',
          coffee: 18,
          water: 25,
          grind: 'Fine',
          temp: 93,
          taste: 'Thick, sweet, punchy',
          bestFor: 'Light-medium roast, Honey Central America',
          stats: { body: 5, clarity: 2, sweetness: 5, acidity: 1 },
          steps: [
            { name: 'Extract', water: 25, duration: 23, instruction: '18g in ‚Üí 25g out in 20-25s' }
          ]
        }
      ]
    };

    const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false }) => {
      const variants = {
        primary: "bg-purple-600 text-white hover:bg-purple-500 border-4 border-purple-400 hover:border-purple-300",
        secondary: "bg-gray-900 text-gray-200 hover:bg-gray-800 border-4 border-gray-600",
        ghost: "text-gray-400 hover:bg-gray-800 hover:text-gray-200 border-2 border-transparent",
        danger: "bg-red-900 text-red-400 hover:bg-red-800 border-4 border-red-500"
      };
      return (
        <button onClick={onClick} disabled={disabled}
          className={`px-4 py-3 font-semibold transition-all flex items-center justify-center gap-2 active:translate-y-1 disabled:opacity-50 text-lg tracking-wide ${variants[variant]} ${className}`}
          style={{borderRadius: '0'}}>
          {children}
        </button>
      );
    };

    const Card = ({ children, className = '', onClick, selected }) => (
      <div onClick={onClick} 
        className={`bg-gray-900 border-4 p-4 transition-all ${selected ? 'border-purple-400 bg-purple-900/30' : 'border-gray-700'} ${onClick ? 'cursor-pointer hover:border-purple-500 hover:bg-gray-800 active:translate-y-1' : ''} ${className}`}
        style={{borderRadius: '0'}}>
        {children}
      </div>
    );

    function App() {
      const [view, setView] = useState('select'); // select, recipe, brew, log, history
      const [selectedBrewer, setSelectedBrewer] = useState(null);
      const [selectedRecipe, setSelectedRecipe] = useState(null);
      const [logs, setLogs] = useState([]);
      const [user, setUser] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);
      const [logsLoading, setLogsLoading] = useState(false);

      // Auth
      useEffect(() => {
        supabase.auth.getSession().then(({ data: { session } }) => {
          setUser(session?.user ?? null);
          setAuthLoading(false);
        });
        const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
          setUser(session?.user ?? null);
        });
        return () => subscription.unsubscribe();
      }, []);

      useEffect(() => {
        if (user) loadLogs();
        else setLogs([]);
      }, [user]);

      const loadLogs = async () => {
        setLogsLoading(true);
        const { data, error } = await supabase.from('brew_logs').select('*').order('created_at', { ascending: false });
        if (!error) {
          setLogs(data.map(log => ({
            id: log.id, date: new Date(log.created_at).toLocaleDateString(),
            beanName: log.roaster, origin: log.origin, varietal: log.varietal,
            roast: log.roast, roastDate: log.roast_date, method: log.method,
            recipe: log.notes?.split('|')[0]?.trim(), coffee: log.coffee_amount,
            rating: log.rating, notes: log.notes
          })));
        }
        setLogsLoading(false);
      };

      const signInWithGoogle = async () => {
        await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: { redirectTo: window.location.origin + window.location.pathname }
        });
      };

      const signOut = () => supabase.auth.signOut();

      // STEP 1: Select Brewer
      const SelectBrewerView = () => (
        <div className="space-y-6 pb-24">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Coffee className="w-8 h-8 text-purple-400" />
              <h1 className="text-purple-400 pixel-glow" style={{fontSize: '1rem', letterSpacing: '2px'}}>BREW BUDDY</h1>
            </div>
            {authLoading ? <Loader className="w-5 h-5 text-gray-500 animate-spin" /> : user ? (
              <button onClick={signOut} className="w-9 h-9 rounded-full overflow-hidden border-2 border-purple-500/50">
                {user.user_metadata?.avatar_url ? <img src={user.user_metadata.avatar_url} className="w-full h-full" /> : <User className="w-5 h-5 text-purple-400" />}
              </button>
            ) : (
              <button onClick={signInWithGoogle} className="px-3 py-1.5 rounded-lg bg-green-500/20 border border-green-500/30 text-green-400 font-semibold text-sm">Login</button>
            )}
          </div>

              <div>
            <h2 className="text-green-400 uppercase tracking-wider mb-4 blink" style={{fontSize: '0.7rem'}}>¬ª SELECT YOUR WEAPON ¬´</h2>
            <div className="grid grid-cols-2 gap-3">
              {Object.entries(BREWERS).map(([key, brewer], index) => (
                <div key={key} onClick={() => { setSelectedBrewer(key); setView('recipe'); }} 
                  className={`border-animate border-delay-${index + 1} cursor-pointer`}>
                  <div className="bg-gray-900 p-4 flex flex-col items-center hover:bg-gray-800 transition-colors">
                    <img src={brewer.image} alt={brewer.name} className="w-16 h-16 object-contain mb-2" style={{imageRendering: 'pixelated'}} />
                    <span className="text-purple-300 text-lg">{brewer.name.toUpperCase()}</span>
                  </div>
                </div>
                  ))}
                </div>
              </div>
                </div>
      );

      // STEP 2: Select Recipe
      const SelectRecipeView = () => {
        const recipes = RECIPES[selectedBrewer] || [];
        const brewer = BREWERS[selectedBrewer];

        return (
          <div className="space-y-5 pb-24">
            <div className="flex items-center gap-3">
              <button onClick={() => setView('select')} className="text-gray-500 hover:text-white">
                <ChevronLeft className="w-6 h-6" />
              </button>
              <div className="flex items-center gap-2">
                <img src={brewer?.image} alt={brewer?.name} className="w-8 h-8 object-contain" />
                <span className="text-white font-bold text-lg">{brewer?.name}</span>
              </div>
            </div>

            <h2 className="text-green-400 uppercase tracking-wider mb-3 blink" style={{fontSize: '0.7rem'}}>¬ª CHOOSE RECIPE ¬´</h2>
            
            <div className="space-y-3">
              {recipes.map((recipe) => (
                <Card key={recipe.id} onClick={() => { setSelectedRecipe(recipe); setView('brew'); }}
                  className="bounce-pixel">
                  {/* Taste Profile - Focal Point */}
                  {recipe.taste && (
                    <p className="text-white text-2xl mb-3">{recipe.taste}</p>
                  )}
                  
                  {/* Best For */}
                  {recipe.bestFor && (
                    <div className="text-lg text-gray-400 mb-4">
                      <span className="text-green-400">Recommended for:</span> {recipe.bestFor}
                    </div>
                  )}
                  
                  <div className="flex justify-between items-center">
                    <span className="text-purple-300" style={{fontSize: '0.8rem'}}>{recipe.name.toUpperCase()}</span>
                    {recipe.source && (
                      <a href={recipe.source} target="_blank" rel="noopener noreferrer" 
                        className="text-gray-500 hover:text-purple-400 uppercase tracking-wider flex items-center gap-1"
                        style={{fontSize: '0.7rem'}}
                        onClick={(e) => e.stopPropagation()}>
                        SOURCE <ExternalLink className="w-3 h-3" />
                      </a>
                    )}
                  </div>
                </Card>
              ))}
            </div>
          </div>
        );
      };

      // STEP 3: Brew Session with Visual Tracker
      const BrewSessionView = () => {
        const [currentStep, setCurrentStep] = useState(0);
        const [timeInStep, setTimeInStep] = useState(0);
        const [totalTime, setTotalTime] = useState(0);
        const [isRunning, setIsRunning] = useState(false);
        const [isComplete, setIsComplete] = useState(false);
        const timerRef = useRef(null);

        const recipe = selectedRecipe;
        const steps = recipe?.steps || [];
        const step = steps[currentStep];

        useEffect(() => {
          if (isRunning && !isComplete) {
            timerRef.current = setInterval(() => {
              setTimeInStep(t => {
                const newTime = t + 1;
                if (newTime >= step.duration && currentStep < steps.length - 1) {
                  setCurrentStep(c => c + 1);
                  return 0;
                } else if (newTime >= step.duration && currentStep === steps.length - 1) {
                  setIsRunning(false);
                  setIsComplete(true);
                }
                return newTime;
              });
              setTotalTime(t => t + 1);
            }, 1000);
          }
          return () => clearInterval(timerRef.current);
        }, [isRunning, currentStep, isComplete]);

        const formatTime = (s) => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
        const progress = step?.duration > 0 ? (timeInStep / step.duration) * 100 : 0;

        if (isComplete) {
          return (
            <div className="flex flex-col items-center justify-center min-h-[70vh] space-y-6">
              <div className="w-20 h-20 rounded-full bg-green-500/20 flex items-center justify-center">
                <Check className="w-10 h-10 text-green-400" />
              </div>
              <h2 className="text-green-400 pixel-glow" style={{fontSize: '1rem'}}>BREW COMPLETE!</h2>
              <p className="text-gray-400 text-xl">TIME: {formatTime(totalTime)}</p>
              <Button onClick={() => setView('log')} className="w-full max-w-xs py-3">
                Log This Brew <ChevronRight className="w-4 h-4" />
              </Button>
              <button onClick={() => { setView('select'); setSelectedRecipe(null); setSelectedBrewer(null); }} 
                className="text-gray-500 hover:text-white text-sm">Skip logging</button>
            </div>
          );
        }

        return (
          <div className="space-y-4 pb-24">
            {/* Header */}
            <div className="flex items-center justify-between">
              <button onClick={() => { setView('recipe'); setIsRunning(false); }} className="text-gray-500 hover:text-white">
                <ChevronLeft className="w-6 h-6" />
              </button>
              <div className="text-center">
                <div className="text-purple-400 font-semibold text-xs uppercase tracking-wider">{BREWERS[selectedBrewer]?.name}</div>
                <div className="text-white font-bold">{recipe?.name}</div>
              </div>
              <div className="text-green-400 text-lg">{formatTime(totalTime)}</div>
            </div>

            {/* Visual Step Tracker */}
            <div className="flex items-center gap-1 py-4 overflow-x-auto">
              {steps.map((s, i) => (
                <React.Fragment key={i}>
                  <div className={`flex flex-col items-center min-w-[60px] ${i <= currentStep ? 'opacity-100' : 'opacity-40'}`}>
                    <div className={`w-8 h-8 flex items-center justify-center text-xs font-bold mb-1 border-2
                      ${i < currentStep ? 'bg-green-500 text-black border-green-300' : i === currentStep ? 'bg-purple-500 text-white border-purple-300 blink' : 'bg-gray-800 text-gray-500 border-gray-600'}`}
                      style={{borderRadius: '0'}}>
                      {i < currentStep ? <Check className="w-4 h-4" /> : i + 1}
                </div>
                    <span className="text-xs text-center text-gray-400 leading-tight">{s.name}</span>
                    {s.water > 0 && <span className="text-xs text-green-400 font-mono">{s.water}g</span>}
              </div>
                  {i < steps.length - 1 && (
                    <div className={`h-1 w-6 ${i < currentStep ? 'bg-green-400' : 'bg-gray-700'}`} />
                  )}
                </React.Fragment>
              ))}
                 </div>
                 
            {/* Current Step Card */}
            <Card className="!p-6 border-purple-500/30">
              <div className="text-center space-y-4">
                <div className="text-gray-500" style={{fontSize: '0.7rem'}}>STAGE {currentStep + 1}/{steps.length}</div>
                <h3 className="text-purple-400 pixel-glow" style={{fontSize: '1rem'}}>{step?.name?.toUpperCase()}</h3>
                <p className="text-gray-300 text-2xl mt-2">{step?.instruction}</p>
                
                {step?.water > 0 && (
                  <div className="inline-block bg-purple-500/20 px-6 py-3 rounded-xl border border-purple-500/30">
                    <div className="text-green-400 text-3xl font-bold font-mono">{step.water}g</div>
                    <div className="text-purple-400/70 text-xs uppercase">Target</div>
                   </div>
                 )}

                {/* Progress bar */}
                <div className="w-full bg-gray-800 h-4 mt-4 border-2 border-gray-700" style={{borderRadius: '0'}}>
                  <div className="h-full transition-all duration-1000" style={{width: `${progress}%`, borderRadius: '0', background: 'linear-gradient(90deg, #22c55e, #a855f7, #ec4899, #f97316)'}} />
                </div>
                <div className="text-purple-400 text-lg">{formatTime(timeInStep)} / {formatTime(step?.duration || 0)}</div>
              </div>
            </Card>

            {/* Controls */}
            <div className="grid grid-cols-2 gap-3">
              {!isRunning ? (
                <Button onClick={() => setIsRunning(true)} className="col-span-2 py-4">
                  <Play className="w-5 h-5" fill="currentColor" /> {totalTime > 0 ? 'RESUME' : 'START'}
                </Button>
              ) : (
                 <>
                  <Button onClick={() => setIsRunning(false)} variant="secondary" className="py-4">
                      <Pause className="w-5 h-5" fill="currentColor" /> PAUSE
                    </Button>
                  <Button onClick={() => { setIsRunning(false); setTimeInStep(0); setTotalTime(0); setCurrentStep(0); }} 
                    variant="danger" className="py-4">
                    <RotateCcw className="w-5 h-5" /> RESET
                    </Button>
                 </>
              )}
            </div>
            <Button onClick={() => setView('log')} variant="ghost" className="w-full mt-2">
              <SkipForward className="w-4 h-4" /> SKIP TO LOG
            </Button>
          </div>
        );
      };

      // STEP 4: Log Bean Info (works for both post-brew and direct access)
      const LogBrewView = () => {
        const [beanName, setBeanName] = useState('');
        const [origin, setOrigin] = useState('Ethiopia');
        const [varietal, setVarietal] = useState('Heirloom');
        const [roast, setRoast] = useState('medium');
        const [roastDate, setRoastDate] = useState('');
        const [method, setMethod] = useState(selectedBrewer || 'v60');
        const [coffee, setCoffee] = useState(selectedRecipe?.coffee || '');
        const [rating, setRating] = useState(0);
        const [notes, setNotes] = useState('');
        const [saving, setSaving] = useState(false);
        
        const hasRecipe = selectedRecipe && selectedBrewer;

        const handleSave = async () => {
          if (!user) { signInWithGoogle(); return; }
          setSaving(true);
          const { error } = await supabase.from('brew_logs').insert({
            user_id: user.id,
            roaster: beanName,
            origin, varietal, roast,
            roast_date: roastDate || null,
            method: hasRecipe ? selectedBrewer : method,
            coffee_amount: hasRecipe ? selectedRecipe.coffee : (coffee || null),
            ratio: hasRecipe ? selectedRecipe.water : 0,
            rating: rating || null,
            notes: hasRecipe ? `${selectedRecipe.name} | ${notes}`.trim() : notes
          });
          setSaving(false);
          if (!error) {
            await loadLogs();
            setView('history');
            setSelectedRecipe(null);
            setSelectedBrewer(null);
          } else {
            alert('Failed to save: ' + error.message);
          }
        };

        return (
          <div className="space-y-5 pb-24">
            {/* Header */}
            <div className="flex items-center justify-between">
              <button onClick={() => hasRecipe ? setView('brew') : setView('history')} className="text-gray-500 hover:text-white">
                <ChevronLeft className="w-6 h-6" />
              </button>
              <h2 className="text-purple-400 pixel-glow" style={{fontSize: '0.9rem'}}>
                {hasRecipe ? '‚òï LOG BREW' : '+ NEW ENTRY'}
              </h2>
              <div className="w-6" /> {/* Spacer for centering */}
            </div>

            {/* Show recipe info if coming from brew flow */}
            {hasRecipe && (
              <div className="relative overflow-hidden border-4 border-purple-500 bg-gradient-to-br from-purple-900/50 to-gray-900 p-4" style={{borderRadius: '0'}}>
                <div className="absolute top-0 right-0 w-20 h-20 bg-purple-500/10 transform rotate-45 translate-x-10 -translate-y-10" />
                <div className="flex items-center gap-4">
                  <img src={BREWERS[selectedBrewer]?.image} alt="" className="w-12 h-12 object-contain opacity-80" />
                  <div className="flex-1">
                    <div className="text-purple-300 text-sm uppercase tracking-wider">{BREWERS[selectedBrewer]?.name}</div>
                    <div className="text-white text-xl">{selectedRecipe.name}</div>
                  </div>
                  <div className="text-right">
                    <div className="text-green-400 text-2xl font-bold">{selectedRecipe.coffee}g</div>
                    <div className="text-gray-500 text-sm">: {selectedRecipe.water}g water</div>
                  </div>
                </div>
              </div>
            )}

            {/* Section: Bean Info */}
            <div>
              <div className="text-green-400 text-sm uppercase tracking-wider mb-3 flex items-center gap-2">
                <span>‚òï</span> BEAN INFO
              </div>
              <Card className="space-y-4">
                <div>
                  <label className="block text-gray-500 text-sm uppercase tracking-wider mb-1">Bean Name / Roaster</label>
                  <input type="text" value={beanName} onChange={e => setBeanName(e.target.value)}
                    placeholder="e.g. Blue Bottle Hayes Valley"
                    className="w-full bg-gray-900 border-2 border-gray-600 px-3 py-2 text-white text-lg focus:border-purple-500 focus:outline-none" style={{borderRadius: '0'}} />
                </div>

                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-gray-500 text-sm uppercase tracking-wider mb-1">Origin</label>
                    <select value={origin} onChange={e => setOrigin(e.target.value)}
                      className="w-full bg-gray-900 border-2 border-gray-600 px-3 py-2 text-white text-lg focus:border-purple-500 focus:outline-none" style={{borderRadius: '0'}}>
                      {COUNTRIES.map(c => <option key={c}>{c}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="block text-gray-500 text-sm uppercase tracking-wider mb-1">Varietal</label>
                    <select value={varietal} onChange={e => setVarietal(e.target.value)}
                      className="w-full bg-gray-900 border-2 border-gray-600 px-3 py-2 text-white text-lg focus:border-purple-500 focus:outline-none" style={{borderRadius: '0'}}>
                      {VARIETALS.map(v => <option key={v}>{v}</option>)}
                    </select>
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="block text-gray-500 text-sm uppercase tracking-wider mb-1">Roast Level</label>
                    <select value={roast} onChange={e => setRoast(e.target.value)}
                      className="w-full bg-gray-900 border-2 border-gray-600 px-3 py-2 text-white text-lg focus:border-purple-500 focus:outline-none" style={{borderRadius: '0'}}>
                      <option value="light">Light</option>
                      <option value="medium">Medium</option>
                      <option value="dark">Dark</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-gray-500 text-sm uppercase tracking-wider mb-1">Roast Date</label>
                    <input type="date" value={roastDate} onChange={e => setRoastDate(e.target.value)}
                      className="w-full bg-gray-900 border-2 border-gray-600 px-3 py-2 text-white text-lg focus:border-purple-500 focus:outline-none" style={{colorScheme:'dark', borderRadius: '0'}} />
                  </div>
                </div>
              </Card>
            </div>

            {/* Section: Brew Details (only when NOT coming from brew flow) */}
            {!hasRecipe && (
              <div>
                <div className="text-green-400 text-sm uppercase tracking-wider mb-3 flex items-center gap-2">
                  <span>‚öóÔ∏è</span> BREW DETAILS
                </div>
                <Card className="space-y-4">
                  <div className="grid grid-cols-2 gap-3">
                    <div>
                      <label className="block text-gray-500 text-sm uppercase tracking-wider mb-1">Brew Method</label>
                      <select value={method} onChange={e => setMethod(e.target.value)}
                        className="w-full bg-gray-900 border-2 border-gray-600 px-3 py-2 text-white text-lg focus:border-purple-500 focus:outline-none" style={{borderRadius: '0'}}>
                        {Object.entries(BREWERS).map(([k,v]) => <option key={k} value={k}>{v.name}</option>)}
                      </select>
                    </div>
                    <div>
                      <label className="block text-gray-500 text-sm uppercase tracking-wider mb-1">Coffee (g)</label>
                      <input type="number" value={coffee} onChange={e => setCoffee(e.target.value === '' ? '' : Number(e.target.value))}
                        placeholder="e.g. 18"
                        className="w-full bg-gray-900 border-2 border-gray-600 px-3 py-2 text-white text-lg text-center focus:border-purple-500 focus:outline-none" style={{borderRadius: '0'}} />
                    </div>
                  </div>
                </Card>
              </div>
            )}

            {/* Section: Rating & Notes */}
            <div>
              <div className="text-green-400 text-sm uppercase tracking-wider mb-3 flex items-center gap-2">
                <span>‚≠ê</span> YOUR REVIEW
              </div>
              <Card className="space-y-4">
                <div>
                  <label className="block text-gray-400 text-sm uppercase tracking-wider mb-3 text-center">HOW WAS IT?</label>
                  <div className="flex gap-3 justify-center">
                    {[1,2,3,4,5].map(s => (
                      <button key={s} onClick={() => setRating(s)} className={`w-12 h-12 border-2 flex items-center justify-center transition-all ${s <= rating ? 'bg-green-500 border-green-300 text-black' : 'bg-gray-800 border-gray-600 text-gray-600'}`} style={{borderRadius: '0'}}>
                        <Star className="w-6 h-6" fill="currentColor" />
                    </button>
                  ))}
                  </div>
                </div>

                <div>
                  <label className="block text-gray-500 text-sm uppercase tracking-wider mb-1">Tasting Notes</label>
                  <textarea value={notes} onChange={e => setNotes(e.target.value)} rows={3}
                    placeholder="Fruity? Chocolatey? Nutty? How did it taste?"
                    className="w-full bg-gray-900 border-2 border-gray-600 px-3 py-2 text-white text-lg resize-none focus:border-purple-500 focus:outline-none" style={{borderRadius: '0'}} />
                </div>
              </Card>
            </div>

            {/* Save Button */}
            <Button onClick={handleSave} disabled={saving} className="w-full py-4 text-xl">
              {saving ? 'SAVING...' : user ? 'üíæ SAVE TO LOG' : 'üîê SIGN IN TO SAVE'}
            </Button>
          </div>
        );
      };

      // Journal / History View
      const HistoryView = () => {
        const [editingLog, setEditingLog] = useState(null);

        const deleteLog = async (id) => {
          if (!confirm('Delete this entry?')) return;
          await supabase.from('brew_logs').delete().eq('id', id);
          loadLogs();
        };

        if (editingLog) {
          return <ManualEntryForm log={editingLog} onClose={() => { setEditingLog(null); }} />;
        }

        return (
          <div className="space-y-4 pb-24">
            <div className="flex items-center justify-between">
              <h2 className="text-purple-400 pixel-glow" style={{fontSize: '0.9rem'}}>BREW LOG</h2>
              {user && (
                <button onClick={() => setView('log')} className="w-9 h-9 bg-purple-900 border-2 border-purple-500 flex items-center justify-center hover:bg-purple-800" style={{borderRadius: '0'}}>
                  <Plus className="w-5 h-5 text-green-400" />
                </button>
              )}
          </div>

            {!user ? (
              <div className="text-center py-20 flex flex-col items-center">
                <Coffee className="w-16 h-16 text-purple-400 mb-6" />
                <p className="text-purple-300 mb-2 text-xl">TRACK YOUR BREWS</p>
                <p className="text-gray-500 mb-8 text-lg">Sign in to save your coffee journal</p>
                <Button onClick={signInWithGoogle}><LogIn className="w-4 h-4" /> SIGN IN WITH GOOGLE</Button>
              </div>
            ) : logsLoading ? (
              <div className="text-center py-20"><Loader className="w-8 h-8 text-gray-500 animate-spin mx-auto" /></div>
            ) : logs.length === 0 ? (
              <div className="text-center py-20 text-gray-500">
                <div className="text-4xl mb-4">‚òï</div>
                <p className="text-lg mb-2">NO ENTRIES YET</p>
                <p className="text-sm"><button onClick={() => setView('select')} className="text-green-400 border-b-2 border-green-400 hover:text-green-300">START BREWING</button> or add a past entry</p>
              </div>
            ) : (
              <div className="space-y-3">
                {logs.map(log => (
                  <Card key={log.id} className="!p-4">
                    <div className="flex justify-between items-start mb-2">
                     <div>
                        <h3 className="text-purple-300 text-lg">{(log.beanName || log.origin || '').toUpperCase()}</h3>
                        <div className="flex gap-2 text-sm text-gray-500 mt-1">
                          <span className="bg-gray-800 border border-gray-700 px-2 py-0.5" style={{borderRadius: '0'}}>{log.varietal}</span>
                          <span>{log.date}</span>
                   </div>
                      </div>
                      {log.rating && (
                        <div className="flex items-center gap-1 bg-purple-900 border-2 border-purple-500 px-2 py-1" style={{borderRadius: '0'}}>
                          <Star className="w-3 h-3 text-green-400" fill="currentColor" />
                          <span className="text-green-400 text-sm font-bold">{log.rating}</span>
                        </div>
                      )}
                      </div>
                    <div className="flex gap-2 text-xs text-gray-400 mb-2">
                      <span>{BREWERS[log.method]?.name || log.method}</span>
                      <span>‚Ä¢</span>
                      <span>{log.coffee}g</span>
                      </div>
                    {log.notes && <p className="text-gray-500 text-sm italic">"{log.notes}"</p>}
                    <div className="flex justify-end gap-2 mt-3 pt-2 border-t border-gray-800">
                      <button onClick={() => setEditingLog(log)} className="text-gray-600 hover:text-green-400"><Edit className="w-4 h-4" /></button>
                      <button onClick={() => deleteLog(log.id)} className="text-gray-600 hover:text-red-400"><Trash className="w-4 h-4" /></button>
                   </div>
                </Card>
                ))}
              </div>
            )}
          </div>
        );
      };

      // Manual Entry Form (for adding past brews)
      const ManualEntryForm = ({ log, onClose }) => {
        const [beanName, setBeanName] = useState(log?.beanName || '');
        const [origin, setOrigin] = useState(log?.origin || 'Ethiopia');
        const [varietal, setVarietal] = useState(log?.varietal || 'Heirloom');
        const [roast, setRoast] = useState(log?.roast || 'medium');
        const [roastDate, setRoastDate] = useState(log?.roastDate || '');
        const [method, setMethod] = useState(log?.method || 'v60');
        const [coffee, setCoffee] = useState(log?.coffee || '');
        const [rating, setRating] = useState(log?.rating || 0);
        const [notes, setNotes] = useState(log?.notes || '');
        const [saving, setSaving] = useState(false);

        const handleSave = async () => {
          setSaving(true);
          const data = {
            user_id: user.id, roaster: beanName, origin, varietal, roast,
            roast_date: roastDate || null, method, coffee_amount: coffee || null,
            ratio: 0, rating: rating || null, notes
          };
          let result;
          if (log) {
            result = await supabase.from('brew_logs').update(data).eq('id', log.id);
          } else {
            result = await supabase.from('brew_logs').insert(data);
          }
          setSaving(false);
          if (!result.error) { await loadLogs(); onClose(); }
          else alert('Error: ' + result.error.message);
        };

        return (
          <div className="space-y-5 pb-24">
            <div className="flex items-center gap-3">
              <button onClick={onClose} className="text-gray-500 hover:text-white"><ChevronLeft className="w-6 h-6" /></button>
              <h2 className="text-white font-bold text-lg">{log ? 'Edit Entry' : 'Add Entry'}</h2>
            </div>
            
            <Card className="space-y-4">
              <div>
                <label className="block text-gray-500 text-sm uppercase tracking-wider mb-1">Bean Name / Roaster</label>
                <input type="text" value={beanName} onChange={e => setBeanName(e.target.value)} 
                  placeholder="e.g. Blue Bottle Hayes Valley"
                  className="w-full bg-gray-900 border-2 border-gray-600 px-3 py-2 text-white text-lg focus:border-purple-500 focus:outline-none" style={{borderRadius: '0'}} />
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-gray-500 text-sm uppercase tracking-wider mb-1">Origin</label>
                  <select value={origin} onChange={e => setOrigin(e.target.value)} className="w-full bg-gray-900 border-2 border-gray-600 px-3 py-2 text-white text-lg focus:border-purple-500 focus:outline-none" style={{borderRadius: '0'}}>
                    {COUNTRIES.map(c => <option key={c}>{c}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-gray-500 text-sm uppercase tracking-wider mb-1">Varietal</label>
                  <select value={varietal} onChange={e => setVarietal(e.target.value)} className="w-full bg-gray-900 border-2 border-gray-600 px-3 py-2 text-white text-lg focus:border-purple-500 focus:outline-none" style={{borderRadius: '0'}}>
                    {VARIETALS.map(v => <option key={v}>{v}</option>)}
                  </select>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-gray-500 text-sm uppercase tracking-wider mb-1">Roast Level</label>
                  <select value={roast} onChange={e => setRoast(e.target.value)} className="w-full bg-gray-900 border-2 border-gray-600 px-3 py-2 text-white text-lg focus:border-purple-500 focus:outline-none" style={{borderRadius: '0'}}>
                    <option value="light">Light</option><option value="medium">Medium</option><option value="dark">Dark</option>
                  </select>
                </div>
                <div>
                  <label className="block text-gray-500 text-sm uppercase tracking-wider mb-1">Roast Date</label>
                  <input type="date" value={roastDate} onChange={e => setRoastDate(e.target.value)} className="w-full bg-gray-900 border-2 border-gray-600 px-3 py-2 text-white text-lg focus:border-purple-500 focus:outline-none" style={{colorScheme:'dark', borderRadius: '0'}} />
                </div>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-gray-500 text-sm uppercase tracking-wider mb-1">Brew Method</label>
                  <select value={method} onChange={e => setMethod(e.target.value)} className="w-full bg-gray-900 border-2 border-gray-600 px-3 py-2 text-white text-lg focus:border-purple-500 focus:outline-none" style={{borderRadius: '0'}}>
                    {Object.entries(BREWERS).map(([k,v]) => <option key={k} value={k}>{v.name}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-gray-500 text-sm uppercase tracking-wider mb-1">Coffee (g)</label>
                  <input type="number" value={coffee} onChange={e => setCoffee(e.target.value === '' ? '' : Number(e.target.value))} 
                    placeholder="e.g. 18"
                    className="w-full bg-gray-900 border-2 border-gray-600 px-3 py-2 text-white text-lg text-center focus:border-purple-500 focus:outline-none" style={{borderRadius: '0'}} />
                </div>
              </div>

              <div>
                <label className="block text-gray-400 text-sm uppercase tracking-wider mb-2">Rating</label>
                <div className="flex gap-3 justify-center">
                  {[1,2,3,4,5].map(s => (
                    <button key={s} onClick={() => setRating(s)} className={`w-10 h-10 border-2 flex items-center justify-center transition-all ${s <= rating ? 'bg-green-500 border-green-300 text-black' : 'bg-gray-800 border-gray-600 text-gray-600'}`} style={{borderRadius: '0'}}>
                      <Star className="w-5 h-5" fill="currentColor" />
                    </button>
                  ))}
                </div>
              </div>

              <div>
                <label className="block text-gray-500 text-sm uppercase tracking-wider mb-1">Tasting Notes</label>
                <textarea value={notes} onChange={e => setNotes(e.target.value)} rows={3} placeholder="How did it taste?"
                  className="w-full bg-gray-900 border-2 border-gray-600 px-3 py-2 text-white text-lg resize-none focus:border-purple-500 focus:outline-none" style={{borderRadius: '0'}} />
              </div>
            </Card>
            
            <Button onClick={handleSave} disabled={saving} className="w-full py-3">{saving ? 'SAVING...' : 'SAVE'}</Button>
        </div>
      );
      };

      return (
        <div className="min-h-screen bg-black text-gray-100 scanlines">
          {/* Bottom Nav */}
          <nav className="fixed bottom-0 left-0 right-0 bg-gray-900 border-t-4 border-purple-500 px-8 py-3 flex justify-around z-50 pb-safe">
<button onClick={() => { setView('select'); setSelectedBrewer(null); setSelectedRecipe(null); }}
              className={`flex flex-col items-center gap-1 px-4 py-1 border-2 ${['select','recipe','brew','log'].includes(view) ? 'text-green-400 border-green-400 bg-green-400/10' : 'text-gray-500 border-transparent'}`}
              style={{borderRadius: '0'}}>
              <Coffee className="w-5 h-5" />
              <span style={{fontSize: '0.65rem'}}>BREW</span>
             </button>
            <button onClick={() => setView('history')}
              className={`flex flex-col items-center gap-1 px-4 py-1 border-2 ${view === 'history' ? 'text-green-400 border-green-400 bg-green-400/10' : 'text-gray-500 border-transparent'}`}
              style={{borderRadius: '0'}}>
              <History className="w-5 h-5" />
              <span style={{fontSize: '0.65rem'}}>LOG</span>
             </button>
          </nav>

          <main className="px-4 py-5 max-w-md mx-auto">
            {view === 'select' && <SelectBrewerView />}
            {view === 'recipe' && <SelectRecipeView />}
            {view === 'brew' && <BrewSessionView />}
            {view === 'log' && <LogBrewView />}
            {view === 'history' && <HistoryView />}
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
