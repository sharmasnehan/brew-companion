<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Brew Buddy</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Fraunces:ital,opsz,wght@0,9..144,400;0,9..144,500;0,9..144,600;0,9..144,700&family=Nunito:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Nunito', sans-serif; }
    body { -webkit-font-smoothing: antialiased; }
    .pb-safe { padding-bottom: env(safe-area-inset-bottom, 0); }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type="number"] { -moz-appearance: textfield; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Supabase client
    const SUPABASE_URL = 'https://yiimyoabdgsubradtejd.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlpaW15b2FiZGdzdWJyYWR0ZWpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwODA5NzQsImV4cCI6MjA4NTY1Njk3NH0.pUWRRIae1GU5u36QcX2JeVR5Qa3JpbSaSUFtHTe2cDU';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Icons
    const Icon = ({ name, className = "w-6 h-6", ...props }) => {
      const ref = useRef(null);
      useEffect(() => {
        if (ref.current && lucide.icons[name]) {
          ref.current.innerHTML = '';
          const icon = lucide.createElement(lucide.icons[name]);
          icon.setAttribute('class', className);
          if (props.fill) icon.setAttribute('fill', props.fill);
          ref.current.appendChild(icon);
        }
      }, [name, className, props.fill]);
      return <span ref={ref} className="inline-flex" />;
    };

    const Coffee = (props) => <Icon name="Coffee" {...props} />;
    const Play = (props) => <Icon name="Play" {...props} />;
    const Pause = (props) => <Icon name="Pause" {...props} />;
    const RotateCcw = (props) => <Icon name="RotateCcw" {...props} />;
    const Check = (props) => <Icon name="Check" {...props} />;
    const ChevronRight = (props) => <Icon name="ChevronRight" {...props} />;
    const ChevronLeft = (props) => <Icon name="ChevronLeft" {...props} />;
    const Star = (props) => <Icon name="Star" {...props} />;
    const History = (props) => <Icon name="History" {...props} />;
    const LogIn = (props) => <Icon name="LogIn" {...props} />;
    const User = (props) => <Icon name="User" {...props} />;
    const Loader = (props) => <Icon name="Loader" {...props} />;
    const Plus = (props) => <Icon name="Plus" {...props} />;
    const X = (props) => <Icon name="X" {...props} />;
    const Trash = (props) => <Icon name="Trash2" {...props} />;
    const Edit = (props) => <Icon name="Pencil" {...props} />;

    const COUNTRIES = ['Ethiopia', 'Colombia', 'Brazil', 'Guatemala', 'Costa Rica', 'Kenya', 'Indonesia', 'Honduras', 'Panama', 'El Salvador', 'Nepal', 'India', 'Other'];
    const VARIETALS = ['Heirloom', 'Bourbon', 'Typica', 'Caturra', 'Catuai', 'Geisha', 'SL-28', 'SL-34', 'Pacamara', 'Castillo', 'Blend', 'Other'];

    // BREWERS AND RECIPES
    const BREWERS = {
      hario_switch: { name: 'Hario Switch', icon: 'ðŸ«–' },
      v60: { name: 'Hario V60', icon: 'âŒµ' },
      aeropress: { name: 'AeroPress', icon: 'ðŸ’¨' },
      chemex: { name: 'Chemex', icon: 'â§–' },
      espresso: { name: 'Espresso', icon: 'â˜•' }
    };

    const RECIPES = {
      hario_switch: [
        {
          id: 'switch_classic',
          name: 'Classic (La Cabra)',
          coffee: 15,
          water: 250,
          grind: 'Medium-Coarse',
          temp: 96,
          steps: [
            { name: 'Add Coffee', water: 0, duration: 0, instruction: 'Rinse filter, add 15g coffee with switch CLOSED' },
            { name: 'Bloom', water: 60, duration: 45, instruction: 'Pour 60g water for bloom' },
            { name: 'Main Pour', water: 250, duration: 30, instruction: 'OPEN switch, pour remaining 190g' },
            { name: 'Drawdown', water: 250, duration: 45, instruction: 'Let it drain completely' }
          ]
        },
        {
          id: 'switch_mugen',
          name: 'Immersion (Mugen Hack)',
          coffee: 15,
          water: 300,
          grind: 'Medium',
          temp: 94,
          steps: [
            { name: 'First Pour', water: 150, duration: 10, instruction: 'Add 150g water and stir' },
            { name: 'Steep', water: 150, duration: 60, instruction: 'Wait 60 seconds' },
            { name: 'Open & Pour', water: 300, duration: 30, instruction: 'OPEN switch, slowly add remaining 150g' },
            { name: 'Drawdown', water: 300, duration: 140, instruction: 'Let it drain (~4 min total)' }
          ]
        }
      ],
      v60: [
        {
          id: 'v60_balanced',
          name: 'Balanced (Kaldi\'s)',
          coffee: 16,
          water: 256,
          grind: 'Medium-Fine',
          temp: 96,
          steps: [
            { name: 'Bloom', water: 40, duration: 40, instruction: 'Pour 40g, swirl gently' },
            { name: 'Main Pour', water: 256, duration: 100, instruction: 'Pour steadily to 256g' },
            { name: 'Drawdown', water: 256, duration: 40, instruction: 'Total time ~3 min' }
          ]
        },
        {
          id: 'v60_pulse',
          name: 'Pulse Pour (5x60g)',
          coffee: 20,
          water: 300,
          grind: 'Medium-Fine',
          temp: 96,
          steps: [
            { name: 'Bloom', water: 60, duration: 45, instruction: 'Pour 60g bloom, swirl' },
            { name: 'Pour 2', water: 120, duration: 30, instruction: 'Pour to 120g' },
            { name: 'Pour 3', water: 180, duration: 30, instruction: 'Pour to 180g' },
            { name: 'Pour 4', water: 240, duration: 30, instruction: 'Pour to 240g' },
            { name: 'Pour 5', water: 300, duration: 30, instruction: 'Pour to 300g' },
            { name: 'Drawdown', water: 300, duration: 45, instruction: 'Total time ~4 min' }
          ]
        }
      ],
      aeropress: [
        {
          id: 'aeropress_standard',
          name: 'Standard',
          coffee: 16,
          water: 200,
          grind: 'Medium-Fine',
          temp: 85,
          steps: [
            { name: 'Add Water', water: 200, duration: 10, instruction: 'Add all 200g water' },
            { name: 'Stir', water: 200, duration: 10, instruction: 'Stir 3 times' },
            { name: 'Steep', water: 200, duration: 40, instruction: 'Wait' },
            { name: 'Press', water: 200, duration: 30, instruction: 'Press gently for 30s' }
          ]
        },
        {
          id: 'aeropress_championship',
          name: 'Championship Style',
          coffee: 18,
          water: 100,
          grind: 'Fine',
          temp: 80,
          bypass: 100,
          steps: [
            { name: 'Add Water', water: 100, duration: 10, instruction: 'Add 100g water' },
            { name: 'Stir', water: 100, duration: 10, instruction: 'Stir gently' },
            { name: 'Press', water: 100, duration: 30, instruction: 'Press after 25-50s' },
            { name: 'Bypass', water: 100, duration: 10, instruction: 'Add 100g hot water to cup' }
          ]
        }
      ],
      chemex: [
        {
          id: 'chemex_howell',
          name: 'George Howell (2 cups)',
          coffee: 32,
          water: 500,
          grind: 'Medium-Coarse',
          temp: 96,
          steps: [
            { name: 'Bloom', water: 65, duration: 45, instruction: 'Pour 65g, let bloom' },
            { name: 'Pour 1', water: 250, duration: 60, instruction: 'Pour slowly to 250g' },
            { name: 'Pour 2', water: 400, duration: 60, instruction: 'Pour to 400g' },
            { name: 'Pour 3', water: 500, duration: 60, instruction: 'Pour to 500g' },
            { name: 'Drawdown', water: 500, duration: 75, instruction: 'Total ~5 min' }
          ]
        },
        {
          id: 'chemex_madcap',
          name: 'Madcap',
          coffee: 42,
          water: 680,
          grind: 'Medium-Coarse',
          temp: 96,
          steps: [
            { name: 'Bloom', water: 80, duration: 45, instruction: 'Pour 80g bloom' },
            { name: 'Pour 1', water: 280, duration: 60, instruction: 'Pour to 280g' },
            { name: 'Pour 2', water: 480, duration: 60, instruction: 'Pour to 480g' },
            { name: 'Pour 3', water: 680, duration: 60, instruction: 'Pour to 680g' },
            { name: 'Drawdown', water: 680, duration: 135, instruction: 'Total 6-7 min' }
          ]
        }
      ],
      espresso: [
        {
          id: 'espresso_classic',
          name: 'Classic 1:2',
          coffee: 18,
          water: 36,
          grind: 'Fine',
          temp: 93,
          steps: [
            { name: 'Extract', water: 36, duration: 28, instruction: '18g in â†’ 36g out in 25-30s' }
          ]
        },
        {
          id: 'espresso_ristretto',
          name: 'Ristretto 1:1.4',
          coffee: 18,
          water: 25,
          grind: 'Fine',
          temp: 93,
          steps: [
            { name: 'Extract', water: 25, duration: 23, instruction: '18g in â†’ 25g out in 20-25s' }
          ]
        }
      ]
    };

    const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false }) => {
      const variants = {
        primary: "bg-gradient-to-r from-purple-600 to-purple-500 text-white hover:from-purple-500 hover:to-purple-400 shadow-lg shadow-purple-500/25",
        secondary: "bg-gray-800 text-gray-200 hover:bg-gray-700 border border-gray-700",
        ghost: "text-gray-400 hover:bg-gray-800 hover:text-gray-200",
        danger: "bg-red-500/20 text-red-400 hover:bg-red-500/30 border border-red-500/30"
      };
      return (
        <button onClick={onClick} disabled={disabled}
          className={`px-4 py-2 rounded-xl font-semibold transition-all flex items-center justify-center gap-2 active:scale-95 disabled:opacity-50 ${variants[variant]} ${className}`}>
          {children}
        </button>
      );
    };

    const Card = ({ children, className = '', onClick, selected }) => (
      <div onClick={onClick} 
        className={`bg-gray-900/80 rounded-2xl border p-4 backdrop-blur-sm transition-all ${selected ? 'border-purple-500 ring-2 ring-purple-500/30' : 'border-purple-500/20'} ${onClick ? 'cursor-pointer hover:border-gray-700' : ''} ${className}`}>
        {children}
      </div>
    );

    function App() {
      const [view, setView] = useState('select'); // select, recipe, brew, log, history
      const [selectedBrewer, setSelectedBrewer] = useState(null);
      const [selectedRecipe, setSelectedRecipe] = useState(null);
      const [logs, setLogs] = useState([]);
      const [user, setUser] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);
      const [logsLoading, setLogsLoading] = useState(false);

      // Auth
      useEffect(() => {
        supabase.auth.getSession().then(({ data: { session } }) => {
          setUser(session?.user ?? null);
          setAuthLoading(false);
        });
        const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
          setUser(session?.user ?? null);
        });
        return () => subscription.unsubscribe();
      }, []);

      useEffect(() => {
        if (user) loadLogs();
        else setLogs([]);
      }, [user]);

      const loadLogs = async () => {
        setLogsLoading(true);
        const { data, error } = await supabase.from('brew_logs').select('*').order('created_at', { ascending: false });
        if (!error) {
          setLogs(data.map(log => ({
            id: log.id, date: new Date(log.created_at).toLocaleDateString(),
            beanName: log.roaster, origin: log.origin, varietal: log.varietal,
            roast: log.roast, roastDate: log.roast_date, method: log.method,
            recipe: log.notes?.split('|')[0]?.trim(), coffee: log.coffee_amount,
            rating: log.rating, notes: log.notes
          })));
        }
        setLogsLoading(false);
      };

      const signInWithGoogle = async () => {
        await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: { redirectTo: window.location.origin + window.location.pathname }
        });
      };

      const signOut = () => supabase.auth.signOut();

      // STEP 1: Select Brewer
      const SelectBrewerView = () => (
        <div className="space-y-6 pb-24">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <Coffee className="w-8 h-8 text-purple-400" />
              <h1 className="text-white" style={{fontFamily: "'Pacifico', cursive", fontSize: '1.75rem'}}>Brew Buddy</h1>
            </div>
            {authLoading ? <Loader className="w-5 h-5 text-gray-500 animate-spin" /> : user ? (
              <button onClick={signOut} className="w-9 h-9 rounded-full overflow-hidden border-2 border-purple-500/50">
                {user.user_metadata?.avatar_url ? <img src={user.user_metadata.avatar_url} className="w-full h-full" /> : <User className="w-5 h-5 text-purple-400" />}
              </button>
            ) : (
              <button onClick={signInWithGoogle} className="px-3 py-1.5 rounded-lg bg-green-500/20 border border-green-500/30 text-green-400 font-semibold text-sm">Login</button>
            )}
          </div>

          <div>
            <h2 className="text-gray-400 font-semibold uppercase tracking-wider text-xs mb-3">Choose Your Brewer</h2>
            <div className="grid grid-cols-2 gap-3">
              {Object.entries(BREWERS).map(([key, brewer]) => (
                <Card key={key} onClick={() => { setSelectedBrewer(key); setView('recipe'); }} 
                  className="flex flex-col items-center py-6 hover:bg-gray-800/50">
                  <span className="text-3xl mb-2">{brewer.icon}</span>
                  <span className="text-white font-semibold text-sm">{brewer.name}</span>
                </Card>
              ))}
            </div>
          </div>
        </div>
      );

      // STEP 2: Select Recipe
      const SelectRecipeView = () => {
        const recipes = RECIPES[selectedBrewer] || [];
        const brewer = BREWERS[selectedBrewer];

        return (
          <div className="space-y-5 pb-24">
            <div className="flex items-center gap-3">
              <button onClick={() => setView('select')} className="text-gray-500 hover:text-white">
                <ChevronLeft className="w-6 h-6" />
              </button>
              <div>
                <span className="text-purple-400 text-2xl mr-2">{brewer?.icon}</span>
                <span className="text-white font-bold text-lg">{brewer?.name}</span>
              </div>
            </div>

            <h2 className="text-gray-400 font-semibold uppercase tracking-wider text-xs">Select Recipe</h2>
            
            <div className="space-y-3">
              {recipes.map((recipe) => (
                <Card key={recipe.id} onClick={() => { setSelectedRecipe(recipe); setView('brew'); }}
                  className="hover:bg-gray-800/50">
                  <div className="flex justify-between items-start mb-2">
                    <h3 className="text-white font-bold">{recipe.name}</h3>
                    <span className="text-green-400 font-mono text-sm">{recipe.coffee}g : {recipe.water}g</span>
                  </div>
                  <div className="flex gap-4 text-gray-500 text-xs">
                    <span>Grind: {recipe.grind}</span>
                    <span>{recipe.temp}Â°C</span>
                  </div>
                  <div className="flex gap-1 mt-3 overflow-x-auto">
                    {recipe.steps.map((step, i) => (
                      <span key={i} className="px-2 py-1 bg-gray-800 rounded text-xs text-gray-400 whitespace-nowrap">
                        {step.name} {step.water > 0 && `â†’ ${step.water}g`}
                      </span>
                    ))}
                  </div>
                </Card>
              ))}
            </div>
          </div>
        );
      };

      // STEP 3: Brew Session with Visual Tracker
      const BrewSessionView = () => {
        const [currentStep, setCurrentStep] = useState(0);
        const [timeInStep, setTimeInStep] = useState(0);
        const [totalTime, setTotalTime] = useState(0);
        const [isRunning, setIsRunning] = useState(false);
        const [isComplete, setIsComplete] = useState(false);
        const timerRef = useRef(null);

        const recipe = selectedRecipe;
        const steps = recipe?.steps || [];
        const step = steps[currentStep];

        useEffect(() => {
          if (isRunning && !isComplete) {
            timerRef.current = setInterval(() => {
              setTimeInStep(t => {
                const newTime = t + 1;
                if (newTime >= step.duration && currentStep < steps.length - 1) {
                  setCurrentStep(c => c + 1);
                  return 0;
                } else if (newTime >= step.duration && currentStep === steps.length - 1) {
                  setIsRunning(false);
                  setIsComplete(true);
                }
                return newTime;
              });
              setTotalTime(t => t + 1);
            }, 1000);
          }
          return () => clearInterval(timerRef.current);
        }, [isRunning, currentStep, isComplete]);

        const formatTime = (s) => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
        const progress = step?.duration > 0 ? (timeInStep / step.duration) * 100 : 0;

        if (isComplete) {
          return (
            <div className="flex flex-col items-center justify-center min-h-[70vh] space-y-6">
              <div className="w-20 h-20 rounded-full bg-green-500/20 flex items-center justify-center">
                <Check className="w-10 h-10 text-green-400" />
              </div>
              <h2 className="text-white text-2xl font-bold" style={{fontFamily: "'Fraunces', serif"}}>Brew Complete!</h2>
              <p className="text-gray-400">Total time: {formatTime(totalTime)}</p>
              <Button onClick={() => setView('log')} className="w-full max-w-xs py-3">
                Log This Brew <ChevronRight className="w-4 h-4" />
              </Button>
              <button onClick={() => { setView('select'); setSelectedRecipe(null); setSelectedBrewer(null); }} 
                className="text-gray-500 hover:text-white text-sm">Skip logging</button>
            </div>
          );
        }

        return (
          <div className="space-y-4 pb-24">
            {/* Header */}
            <div className="flex items-center justify-between">
              <button onClick={() => { setView('recipe'); setIsRunning(false); }} className="text-gray-500 hover:text-white">
                <ChevronLeft className="w-6 h-6" />
              </button>
              <div className="text-center">
                <div className="text-purple-400 font-semibold text-xs uppercase tracking-wider">{BREWERS[selectedBrewer]?.name}</div>
                <div className="text-white font-bold">{recipe?.name}</div>
              </div>
              <div className="text-gray-500 font-mono text-sm">{formatTime(totalTime)}</div>
            </div>

            {/* Visual Step Tracker */}
            <div className="flex items-center gap-1 py-4 overflow-x-auto">
              {steps.map((s, i) => (
                <React.Fragment key={i}>
                  <div className={`flex flex-col items-center min-w-[60px] ${i <= currentStep ? 'opacity-100' : 'opacity-40'}`}>
                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold mb-1
                      ${i < currentStep ? 'bg-green-500 text-white' : i === currentStep ? 'bg-purple-500 text-white' : 'bg-gray-700 text-gray-400'}`}>
                      {i < currentStep ? <Check className="w-4 h-4" /> : i + 1}
                    </div>
                    <span className="text-xs text-center text-gray-400 leading-tight">{s.name}</span>
                    {s.water > 0 && <span className="text-xs text-green-400 font-mono">{s.water}g</span>}
                  </div>
                  {i < steps.length - 1 && (
                    <div className={`h-0.5 w-6 ${i < currentStep ? 'bg-green-500' : 'bg-gray-700'}`} />
                  )}
                </React.Fragment>
              ))}
            </div>

            {/* Current Step Card */}
            <Card className="!p-6 border-purple-500/30">
              <div className="text-center space-y-4">
                <div className="text-purple-400 font-semibold uppercase tracking-wider text-xs">Step {currentStep + 1} of {steps.length}</div>
                <h3 className="text-white text-2xl font-bold" style={{fontFamily: "'Fraunces', serif"}}>{step?.name}</h3>
                <p className="text-gray-300 text-lg">{step?.instruction}</p>
                
                {step?.water > 0 && (
                  <div className="inline-block bg-purple-500/20 px-6 py-3 rounded-xl border border-purple-500/30">
                    <div className="text-green-400 text-3xl font-bold font-mono">{step.water}g</div>
                    <div className="text-purple-400/70 text-xs uppercase">Target</div>
                  </div>
                )}

                {/* Progress bar */}
                <div className="w-full bg-gray-800 rounded-full h-2 mt-4">
                  <div className="bg-purple-500 h-2 rounded-full transition-all duration-1000" style={{width: `${progress}%`}} />
                </div>
                <div className="text-gray-500 font-mono text-sm">{formatTime(timeInStep)} / {formatTime(step?.duration || 0)}</div>
              </div>
            </Card>

            {/* Controls */}
            <div className="grid grid-cols-2 gap-3">
              {!isRunning ? (
                <Button onClick={() => setIsRunning(true)} className="col-span-2 py-4">
                  <Play className="w-5 h-5" fill="currentColor" /> {totalTime > 0 ? 'Resume' : 'Start'}
                </Button>
              ) : (
                <>
                  <Button onClick={() => setIsRunning(false)} variant="secondary" className="py-4">
                    <Pause className="w-5 h-5" fill="currentColor" /> Pause
                  </Button>
                  <Button onClick={() => { setIsRunning(false); setTimeInStep(0); setTotalTime(0); setCurrentStep(0); }} 
                    variant="danger" className="py-4">
                    <RotateCcw className="w-5 h-5" /> Reset
                  </Button>
                </>
              )}
            </div>
          </div>
        );
      };

      // STEP 4: Log Bean Info
      const LogBrewView = () => {
        const [beanName, setBeanName] = useState('');
        const [origin, setOrigin] = useState('Ethiopia');
        const [varietal, setVarietal] = useState('Heirloom');
        const [roast, setRoast] = useState('medium');
        const [roastDate, setRoastDate] = useState('');
        const [rating, setRating] = useState(0);
        const [notes, setNotes] = useState('');
        const [saving, setSaving] = useState(false);

        const handleSave = async () => {
          if (!user) { signInWithGoogle(); return; }
          setSaving(true);
          const { error } = await supabase.from('brew_logs').insert({
            user_id: user.id,
            roaster: beanName,
            origin, varietal, roast,
            roast_date: roastDate || null,
            method: selectedBrewer,
            coffee_amount: selectedRecipe?.coffee,
            ratio: selectedRecipe?.water,
            rating: rating || null,
            notes: `${selectedRecipe?.name} | ${notes}`.trim()
          });
          setSaving(false);
          if (!error) {
            await loadLogs();
            setView('history');
            setSelectedRecipe(null);
            setSelectedBrewer(null);
          } else {
            alert('Failed to save: ' + error.message);
          }
        };

        return (
          <div className="space-y-5 pb-24">
            <div className="flex items-center gap-3">
              <button onClick={() => setView('brew')} className="text-gray-500 hover:text-white">
                <ChevronLeft className="w-6 h-6" />
              </button>
              <h2 className="text-white font-bold text-lg">Log Your Beans</h2>
            </div>

            <Card className="space-y-4">
              <div>
                <label className="block text-gray-400 text-xs font-semibold uppercase tracking-wider mb-1">Bean Name / Roaster</label>
                <input type="text" value={beanName} onChange={e => setBeanName(e.target.value)}
                  placeholder="e.g. Blue Bottle Hayes Valley"
                  className="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white" />
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-gray-400 text-xs font-semibold uppercase tracking-wider mb-1">Origin</label>
                  <select value={origin} onChange={e => setOrigin(e.target.value)}
                    className="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
                    {COUNTRIES.map(c => <option key={c}>{c}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-gray-400 text-xs font-semibold uppercase tracking-wider mb-1">Varietal</label>
                  <select value={varietal} onChange={e => setVarietal(e.target.value)}
                    className="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
                    {VARIETALS.map(v => <option key={v}>{v}</option>)}
                  </select>
                </div>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-gray-400 text-xs font-semibold uppercase tracking-wider mb-1">Roast Level</label>
                  <select value={roast} onChange={e => setRoast(e.target.value)}
                    className="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
                    <option value="light">Light</option>
                    <option value="medium">Medium</option>
                    <option value="dark">Dark</option>
                  </select>
                </div>
                <div>
                  <label className="block text-gray-400 text-xs font-semibold uppercase tracking-wider mb-1">Roast Date</label>
                  <input type="date" value={roastDate} onChange={e => setRoastDate(e.target.value)}
                    className="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white" style={{colorScheme:'dark'}} />
                </div>
              </div>

              <div>
                <label className="block text-gray-400 text-xs font-semibold uppercase tracking-wider mb-2">Rating</label>
                <div className="flex gap-2 justify-center">
                  {[1,2,3,4,5].map(s => (
                    <button key={s} onClick={() => setRating(s)} className="transition-transform hover:scale-110">
                      <Star className={`w-8 h-8 ${s <= rating ? 'text-green-400' : 'text-gray-700'}`} fill={s <= rating ? 'currentColor' : 'none'} />
                    </button>
                  ))}
                </div>
              </div>

              <div>
                <label className="block text-gray-400 text-xs font-semibold uppercase tracking-wider mb-1">Tasting Notes</label>
                <textarea value={notes} onChange={e => setNotes(e.target.value)} rows={3}
                  placeholder="How did it taste?"
                  className="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white resize-none" />
              </div>
            </Card>

            <Button onClick={handleSave} disabled={saving} className="w-full py-3">
              {saving ? 'Saving...' : user ? 'Save to Journal' : 'Sign in to Save'}
            </Button>
          </div>
        );
      };

      // Journal / History View
      const HistoryView = () => {
        const [showAdd, setShowAdd] = useState(false);
        const [editingLog, setEditingLog] = useState(null);

        const deleteLog = async (id) => {
          if (!confirm('Delete this entry?')) return;
          await supabase.from('brew_logs').delete().eq('id', id);
          loadLogs();
        };

        if (showAdd || editingLog) {
          return <ManualEntryForm log={editingLog} onClose={() => { setShowAdd(false); setEditingLog(null); }} />;
        }

        return (
          <div className="space-y-4 pb-24">
            <div className="flex items-center justify-between">
              <h2 className="text-white font-bold text-xl" style={{fontFamily: "'Pacifico', cursive"}}>Journal</h2>
              {user && (
                <button onClick={() => setShowAdd(true)} className="w-9 h-9 rounded-full bg-purple-500/20 border border-purple-500/30 flex items-center justify-center">
                  <Plus className="w-5 h-5 text-green-400" />
                </button>
              )}
            </div>

            {!user ? (
              <div className="text-center py-20">
                <p className="text-gray-400 mb-4">Sign in to save your brews</p>
                <Button onClick={signInWithGoogle}><LogIn className="w-4 h-4" /> Sign in with Google</Button>
              </div>
            ) : logsLoading ? (
              <div className="text-center py-20"><Loader className="w-8 h-8 text-gray-500 animate-spin mx-auto" /></div>
            ) : logs.length === 0 ? (
              <div className="text-center py-20 text-gray-500">
                <History className="w-16 h-16 mx-auto mb-4 opacity-30" />
                <p><button onClick={() => setView('select')} className="text-green-400 underline">Record your first brew</button> or add a past entry</p>
              </div>
            ) : (
              <div className="space-y-3">
                {logs.map(log => (
                  <Card key={log.id} className="!p-4">
                    <div className="flex justify-between items-start mb-2">
                      <div>
                        <h3 className="text-white font-bold">{log.beanName || log.origin}</h3>
                        <div className="flex gap-2 text-xs text-gray-500 mt-1">
                          <span className="bg-gray-800 px-2 py-0.5 rounded">{log.varietal}</span>
                          <span>{log.date}</span>
                        </div>
                      </div>
                      {log.rating && (
                        <div className="flex items-center gap-1 bg-purple-500/20 px-2 py-1 rounded-full">
                          <Star className="w-3 h-3 text-green-400" fill="currentColor" />
                          <span className="text-green-400 text-xs font-bold">{log.rating}</span>
                        </div>
                      )}
                    </div>
                    <div className="flex gap-2 text-xs text-gray-400 mb-2">
                      <span>{BREWERS[log.method]?.name || log.method}</span>
                      <span>â€¢</span>
                      <span>{log.coffee}g</span>
                    </div>
                    {log.notes && <p className="text-gray-500 text-sm italic">"{log.notes}"</p>}
                    <div className="flex justify-end gap-2 mt-3 pt-2 border-t border-gray-800">
                      <button onClick={() => setEditingLog(log)} className="text-gray-600 hover:text-green-400"><Edit className="w-4 h-4" /></button>
                      <button onClick={() => deleteLog(log.id)} className="text-gray-600 hover:text-red-400"><Trash className="w-4 h-4" /></button>
                    </div>
                  </Card>
                ))}
              </div>
            )}
          </div>
        );
      };

      // Manual Entry Form (for adding past brews)
      const ManualEntryForm = ({ log, onClose }) => {
        const [beanName, setBeanName] = useState(log?.beanName || '');
        const [origin, setOrigin] = useState(log?.origin || 'Ethiopia');
        const [varietal, setVarietal] = useState(log?.varietal || 'Heirloom');
        const [roast, setRoast] = useState(log?.roast || 'medium');
        const [roastDate, setRoastDate] = useState(log?.roastDate || '');
        const [method, setMethod] = useState(log?.method || 'v60');
        const [coffee, setCoffee] = useState(log?.coffee || 16);
        const [rating, setRating] = useState(log?.rating || 0);
        const [notes, setNotes] = useState(log?.notes || '');
        const [saving, setSaving] = useState(false);

        const handleSave = async () => {
          setSaving(true);
          const data = {
            user_id: user.id, roaster: beanName, origin, varietal, roast,
            roast_date: roastDate || null, method, coffee_amount: coffee,
            ratio: 0, rating: rating || null, notes
          };
          let result;
          if (log) {
            result = await supabase.from('brew_logs').update(data).eq('id', log.id);
          } else {
            result = await supabase.from('brew_logs').insert(data);
          }
          setSaving(false);
          if (!result.error) { await loadLogs(); onClose(); }
          else alert('Error: ' + result.error.message);
        };

        return (
          <div className="space-y-4 pb-24">
            <div className="flex items-center gap-3">
              <button onClick={onClose} className="text-gray-500 hover:text-white"><X className="w-6 h-6" /></button>
              <h2 className="text-white font-bold">{log ? 'Edit Entry' : 'Add Entry'}</h2>
            </div>
            <Card className="space-y-3">
              <input type="text" value={beanName} onChange={e => setBeanName(e.target.value)} placeholder="Bean name / Roaster"
                className="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white" />
              <div className="grid grid-cols-2 gap-3">
                <select value={origin} onChange={e => setOrigin(e.target.value)} className="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
                  {COUNTRIES.map(c => <option key={c}>{c}</option>)}
                </select>
                <select value={varietal} onChange={e => setVarietal(e.target.value)} className="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
                  {VARIETALS.map(v => <option key={v}>{v}</option>)}
                </select>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <select value={roast} onChange={e => setRoast(e.target.value)} className="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
                  <option value="light">Light</option><option value="medium">Medium</option><option value="dark">Dark</option>
                </select>
                <input type="date" value={roastDate} onChange={e => setRoastDate(e.target.value)} className="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white" style={{colorScheme:'dark'}} />
              </div>
              <div className="grid grid-cols-2 gap-3">
                <select value={method} onChange={e => setMethod(e.target.value)} className="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white">
                  {Object.entries(BREWERS).map(([k,v]) => <option key={k} value={k}>{v.name}</option>)}
                </select>
                <input type="number" value={coffee} onChange={e => setCoffee(Number(e.target.value))} placeholder="Coffee (g)"
                  className="bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white text-center" />
              </div>
              <div className="flex gap-2 justify-center py-2">
                {[1,2,3,4,5].map(s => (
                  <button key={s} onClick={() => setRating(s)}><Star className={`w-7 h-7 ${s <= rating ? 'text-green-400' : 'text-gray-700'}`} fill={s <= rating ? 'currentColor' : 'none'} /></button>
                ))}
              </div>
              <textarea value={notes} onChange={e => setNotes(e.target.value)} rows={2} placeholder="Notes"
                className="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2 text-white resize-none" />
            </Card>
            <Button onClick={handleSave} disabled={saving} className="w-full py-3">{saving ? 'Saving...' : 'Save'}</Button>
          </div>
        );
      };

      return (
        <div className="min-h-screen bg-black text-gray-100">
          {/* Bottom Nav */}
          <nav className="fixed bottom-0 left-0 right-0 bg-black/95 backdrop-blur border-t border-gray-800 px-8 py-3 flex justify-around z-50 pb-safe">
            <button onClick={() => { setView('select'); setSelectedBrewer(null); setSelectedRecipe(null); }}
              className={`flex flex-col items-center gap-1 ${['select','recipe','brew','log'].includes(view) ? 'text-green-400' : 'text-gray-600'}`}>
              <Coffee className="w-5 h-5" />
              <span className="text-xs font-semibold">Brew</span>
            </button>
            <button onClick={() => setView('history')}
              className={`flex flex-col items-center gap-1 ${view === 'history' ? 'text-green-400' : 'text-gray-600'}`}>
              <History className="w-5 h-5" />
              <span className="text-xs font-semibold">Journal</span>
            </button>
          </nav>

          <main className="px-4 py-5 max-w-md mx-auto">
            {view === 'select' && <SelectBrewerView />}
            {view === 'recipe' && <SelectRecipeView />}
            {view === 'brew' && <BrewSessionView />}
            {view === 'log' && <LogBrewView />}
            {view === 'history' && <HistoryView />}
          </main>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
